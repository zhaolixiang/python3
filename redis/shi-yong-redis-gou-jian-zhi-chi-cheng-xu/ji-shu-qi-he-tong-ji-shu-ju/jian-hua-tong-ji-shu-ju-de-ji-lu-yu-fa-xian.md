# 简化统计数据的记录与发现

在将统计数据存储到Redis里面之后，接下来我们该做些什么呢？说的更详细一点，在知道了访问每个页面所需的时间之后，我们要怎样才能找到那些生成速度较慢的网页？或者说，当某个页面的生成速度变得比以往要慢的时候，我们如何才能知悉这一情况？简单的说，为了发现以上提到的这些情况，我们需要存储更多信息，而具体的方法将这一节里面介绍。

要记录页面的访问时长，程序就必须在页面被访问时进行计时。为了做到这一点，我们可以在各个不同的页面设置计时器，并添加代码来记录计时的结果，但最好的办法是直接实现一个能够进行计时并将计时结果存储起来的东西，让它将平均访问速度最慢的页面都记录到一个有序集合里面，并向我们报告哪些页面的载入时间变得比以前更长了。

为了计算和记录访问时长，我们会编写一个Python上下文管理器，并使用这个上下文管理器来包裹那些需要计算并记录访问时长的代码。

> 在Python里面，一个上下文管理器就是一个专门定义的函数或者类，这个函数或者类的不同部分可以在一段代码执行之前以及执行之后分别执行。上下文管理器使得用户可以很容易地实现类似【自动关闭已打开的文件】这样的功能。

下面代码展示了用于计算和记录访问时长的上下文管理器：程序首先会取得当前时间，接着执行被包裹的代码，然后计算这些代码的执行时长，并将结果记录到  
Redis里面；除此之外，程序还会对记录当前上下文最大访问的时间的有序集合进行更新。

```
import contextlib
import time

#将这个Python生成器用作上下文管理器
@contextlib.contextmanager
def access__time(conn,context):
    #记录代码块执行前的时间
    start=time.time()
    #运行被包裹的代码块
    yield

    #计算代码块的执行时长
    data=time.time()-start
    #更新这一上下文的统计数据
    stats=update_stats(conn,context,'AccessTime',data)
    #计算页面的平局访问时长
    average=stats[1]/stats[0]

    pipe=conn.pipeline(True)
    #将页面的平均访问时长添加到记录最长访问时间的有序集合里面
    pipe.zadd('slowest:AccessTime',context,average)
    #AccessTime有序集合只会保留最慢的100条记录
    pipe.zremrangebyrank('slowessTime',0,-101)
    pipe.execute()

```



