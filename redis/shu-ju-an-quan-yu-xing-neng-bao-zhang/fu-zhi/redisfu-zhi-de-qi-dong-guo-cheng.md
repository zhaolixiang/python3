# Redis复制的启动过程

上面曾将说过，从服务器在连接一个主服务器的时候，主服务器会创建一个快照文件并将其发送至从服务器，但这只是主从复制执行的其中一步，下表完整的列出了当从服务器连接主服务器时，主从服务器执行的所有操作：

| 步骤 | 主服务器操作 | 从服务器操作 |
| :--- | :--- | :--- |
| 1 | （等待命令进入） | 连接（或者重连接）主服务，发送sync命令。 |
| 2 | 开始执行bgsave，并使用缓冲区记录bgsave之后执行的所有写命令 | 根据配置选项来决定是继续使用现有的数据（如果有的话）来处理客户端的命令请求，还是向发送请求的客户端返回错误。 |
| 3 | bgsave执行完毕，向从服务器发送快照文件，并在发送期间继续使用缓冲区记录被执行的写命令 | 丢弃所有旧数据（如果有的话），开始载入主服务器发来的快照文件。 |
| 4 | 快照文件发送完毕，开始向从服务器发送存储在缓冲区里面的写命令。 | 完成对快照文件的解释操作，像往常一样开始接受命令请求。 |
| 5 | 缓冲区存储的写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相应的写命令。 | 执行主服务器发送的所有存储在缓冲区里面的写命令；并从现在开始，接受并执行主服务传来的每个写命令。 |

Redis在复制进行期间也会尽可能地处理接受到的命令请求，但是，如果主从服务器之间的网络带宽不足，或者主服务器没有足够的内存来创建子进程和创建记录写命令的缓冲区，那么Redis处理命令请求的效率会受到影响。因此，尽管这并不是必需的，但在实际中华最好还是让主服务器只使用50%~65%的内存，预留30%~45%烦人内存用于执行bgsave命令和创建记录写命令的缓冲区。



