# 速度和耐久性

要理解MongoDB实现持久化的方法，首先需要先理解一下思想。子啊数据库系统领域内，写速度和持久性存在一种相反的关系。写速度可以理解为在给定时间内数据库可以处理的插入、更新和删除操作的数量。持久性则是指数据库保存这些写操作结果不变的时间长短。

举例来说，假设要向数据库写入100条50KB的记录，随后立即切断服务器的电影。机器重启后这些记录能恢复吗？答案是：有可能，这取决于数据库系统和托管它的硬件。问题是写磁盘的速度要比写内存慢几个数量级。

某些数据库，例如memcached，只写内存，这让它们速度很快，但数据完全易失。另一个方面，几乎没有数据库只写磁盘，因为这样的操作性能过低，无法接受。因此，数据库设计者经常需要在速度和持久化中做出权衡，以平衡两者的关系。

在MongoDB中，用户可以选择写入语义，决定是否开启Journaling日志记录，通过这种方式来控制速度和持久性间的平衡。默认所有的写操作都是fire-and-forgetd的，即写操作通过TCP套接字发送，不要求数据库应答。如果用户需要获得应答，可以使用特殊的安全模式发起写操作，所有驱动都提供这个安全模式。该模式强制数据库作出应答，确保数据库正确无误地接收到了写操作。安全模式是可配置的，还可用于阻塞操作，直到写操作被复制到特定数量的服务器。对于高容量、低价值的数据（例如点击流和日志），fire-and-forget风格的写操作是很理想的选择。对于重要的数据，则更倾向于安全模式。

在MongoDB2.0中，Journaling日志是默认开启的。有了这个功能，所有写操作都会被提交到一个只能追加的日志里。即使服务器非正常关闭（比如电源故障），该日志也能保证在重启服务器后MongoDB的数据文件被复制到一致的状态。这是运行MongoDB最安全的方式。

> 事务日志
>
> MySQL的InnoDB中有一个关于速度和持久性的折中。InnoDB是事务性存储引擎，根据定义，必须保证持久性。它通过向两个地方写入更新来实现这一目标：先写事务日志，再写内存缓冲池。事务日志会立刻同步到磁盘，而缓冲池则会由后台线程最终同步。采取这种双重写入的原因是一般来讲随机I/O要比顺序I/O慢得多、因为向主数据文件的写操作后操作构成随机I/O，所以先写内存会更快，尅后面再同步到磁盘上。但有些写操作（至磁盘）要保持持久性，保证写入是连续的这一点很重要，这就是事务日志的功能。在非正常关闭时，InnoDB能回放事务日志，并依次来更新主数据文件。这种做法是保证高持久性的同时也提供了能接受的性能。



